#!/bin/sh
set -x
set -e

BUILD=$1
CACHE=$2
rm -rf $CACHE/*
cd $CACHE

if cd snappy; then
  git pull
else
  git clone https://github.com/google/snappy.git --depth 1 --single-branch --branch=1.1.4
  cd snappy
fi
./autogen.sh
./configure --prefix=/app/vendor
make
make install
cd -

if cd libpostal; then
  git pull
else
  git clone https://github.com/openvenues/libpostal --depth 1 --single-branch --branch=master
  cd libpostal
fi
./bootstrap.sh
LDFLAGS="-L/app/vendor/lib" CFLAGS="-I/app/vendor/include" PKG_CONFIG_PATH="/app/vendor/lib/pkgconfig" ./configure --prefix=/app/vendor #--datadir=/app/vendor/libpostal-data --disable-data-download
make
make install

mkdir --parent $BUILD/vendor
cp --recursive /app/vendor/bin /app/vendor/lib /app/vendor/include $BUILD/vendor
